# Адаптивный кеш: теория и суть

## 1. Идея и методология

### 1.1 Теория массового обслуживания (ТМО)

- **Потоки заявок**  
  Пользовательские запросы к системе описываются параметром **λ** (интенсивность прихода, запросов в единицу времени).
- **Сервера и скорость обработки**  
  Система кеша работает как «быстрый сервер» (μ<sub>h</sub>), внешний источник — как «медленный сервер» (μ<sub>m</sub>).
- **Двухуровневая модель**
    1. M/M/1-сервер для кеша.
    2. M/M/1-сервер для внешнего источника (обслуживает только cache‐miss’ы).
- **Ключевые метрики**
    - Нагрузка: ρ = λ/μ
    - Среднее время в системе (W) и в очереди (W<sub>q</sub>)
    - Вероятность устаревания (staleness) и риск выдачи «старыx» данных

### 1.2 Имитационное моделирование

- **Чёрный ящик с задержками**  
  Эмуляция внешнего источника с управляемым распределением сервисного времени (минимум–максимум) и фоновыми
  «обновлениями» (параметр λ<sub>upd</sub>).
- **Гибкость сценариев**
    - Случайные (пуассоновские) изменения
    - Периодические обновления по расписанию
    - Пики нагрузки, синфазные флуктуации
- **Инструменты**  
  Симуляторы на базе SimPy (Python), которые позволяют «подглядывать» в каждый этап обработки запросов.

### 1.3 Адаптивные и предиктивные стратегии кеширования

1. **Фиксированный TTL**  
   Каждая запись живёт ровно **T** времени: по истечении — обязательный cache‐miss.
2. **Адаптивный TTL**
    - **Идея:** менять время жизни **T** динамически, исходя из текущих метрик:
        - Частота обновлений источника (λ̂<sub>upd</sub>)
        - Интенсивность запросов (λ̂<sub>u</sub>)
        - Доля устаревших ответов (p<sub>stale</sub>)
    - **Методы настройки T:**
        1. **Обратная пропорциональность**  
           T<sub>i+1</sub> = θ / λ̂<sub>upd</sub>(T<sub>i</sub>), где θ — коэффициент сглаживания.
        2. **Минимизация функции затрат**  
           C(T) = c<sub>miss</sub>·(1–p<sub>hit</sub>(T)) + c<sub>stale</sub>·p<sub>stale</sub>(T).
        3. **Гибридная линейная комбинация**  
           T<sub>i+1</sub> = α·1/λ̂<sub>upd</sub> + β·1/λ̂<sub>u</sub>.
    - **Самосогласование**  
      Устанавливаем фиксированную точку T<sup>*</sup>, удовлетворяющую T<sup>*</sup> = f(λ̂<sub>upd</sub>(T<sup>
      *</sup>), λ̂<sub>u</sub>(T<sup>*</sup>), p<sub>stale</sub>(T<sup>*</sup>)).

3. **Гибридные методы**
    - **Реактивная часть:** инвалидация по адаптивному TTL или порогу staleness.
    - **Предиктивная часть:** по вторичным сигналам (например, изменение соседних ключей, временные закономерности)
      заранее обновлять записи через background‐fetch.

---

## 2. Почему адаптивный кеш важен

- **Компромисс латентность ↔ точность**  
  Уменьшая TTL, мы снижаем вероятность выдачи устаревших данных, но растёт нагрузка на «чёрный ящик» и среднее время
  ответа.
- **Динамическая среда**  
  Поток запросов и частота обновлений могут меняться во времени (утренние/вечерние пики, форс-мажорные события).
- **Самонастраиваемость**  
  Адаптивный механизм позволяет системе автоматически подстроиться под текущую нагрузку и особенности данных без ручной
  переконфигурации.

---

## 3. Итоги

1. **ТМО** даёт математический аппарат для анализа двухуровневой системы кеш–источник.
2. **Имитационное моделирование** (SimPy) — мощный инструмент для оценки «чёрного ящика» в самых разных сценариях.
3. **Адаптивные и гибридные стратегии** позволяют добиться баланса между скоростью ответов и актуальностью данных,
   автоматически реагируя на изменение условий работы системы.  
